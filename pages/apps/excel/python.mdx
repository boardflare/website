---
title: Python for Excel
icon: python.png
---

import { Callout } from 'nextra/components'

# Python for Excel

<Callout type="warning" emoji="üß™">
  **EXPERIMENTAL**:  Expect breaking changes.
</Callout>

<a href="https://appsource.microsoft.com/en-us/product/office/WA200007447?tab=Overview">
    <img 
        src="/images/MS_AppSource.png" 
        alt="AppSource"
        style={{ paddingTop: '10px', width: '150px' }}
    />
</a>

## Python as a Function

Run Python code as a function to power your formulas and LAMBDA functions, which is not possible with Excel's native `PY` feature.  It is as simple as the following:
    
```excel
=LAMBDA(x, BOARDFLARE.RUNPY("arg1 + 2", x))
=MYFUNC(5) = 7
```
This enables you to build custom functions using Python without building a custom Excel add-in.

## Features

Some key differences compared to the native [Python in Excel](https://support.microsoft.com/en-us/office/get-started-with-python-in-excel-a33fbcbe-065b-41d3-82cf-23d05397f53d) are as follows:

‚úÖ Use as a function in formulas and LAMBDAs.<br/>
üÜì Free add-in, no Office 365 license required.<br/>
üåê Works in Excel for web as well as desktop.<br/>
‚òÅÔ∏è Runtime has network access for API calls (need CORS).<br/>
üì¶ Import custom packages (pure Python only).<br/>
üîí Runs locally, so no data is shared outside Excel.<br/>
‚û°Ô∏è Code can be loaded from a URL.<br/>
üöÄ Performance is only limited by your CPU.<br/>

## Python Runtime

[Pyodide](https://pyodide.org/en/stable/index.html) is the Python runtime, which is based on [WebAssembly](https://webassembly.org/) running in the browser used by Excel desktop and web to host add-ins.  This is currently running Python 3.12, but has limitations as discussed in the [Pyodide documentation](https://pyodide.org/en/stable/usage/wasm-constraints.html).

Any output to `stdout` or `stderr` is displayed in the Console area of the add-in task pane. This is useful for debugging your code, and also for displaying intermediate results of long-running operations such as functions that are processing large input arrays. Global variables are used to pass data to your code, as discussed in more detail below.  Global variables are cleared after each function invocation, so no state is maintained between calls.

## Custom Packages

Pyodide includes a number of [built-in packages](https://pyodide.org/en/stable/usage/packages-in-pyodide.html). You can import any of these packages as well as those from the Python standard library. Any imports for external Python packages will be loaded from [PyPI](https://pypi.org/), but only if they are pure Python, which means there is a Python wheel that ends with `-py3-none-any.whl`, e.g. `beautifulsoup4-4.12.3-py3-none-any.whl`.  Packages tagged as [OS-independent](https://pypi.org/search/?q=&o=&c=Operating+System+%3A%3A+OS+Independent) on PyPI should work, but double-check the wheel.

You do not need to install packages, just import them in your code.  Your code will be scanned for imports and any found will be handled for you using `micropip` in the background and the package will be downloaded if needed from PyPI.  If you try to import an external package (not part of the Python standard library or one of the built-in packages) for which there is not a pure Python wheel available on PyPI, an error will be thrown.

### Loading Code

Code can be loaded from a URL, which is useful for sharing code between workbooks and version control.  This is done by passing the URL as the code argument to the `RUNPY` function as explained further below, which must end in `.py` or `.ipynb`.  If it is an `.ipynb` file, the code will be extracted from the code cell in the notebook with a `function` tag.  Adding tags to code cells varies by Jupyter implementation in VS Code, Notebooks, JupyterLab, etc.

Code can only be loaded from a URL if it is served over HTTPS and has CORS headers due to browser security restrictions, since add-ins run in a browser environment even in desktop Excel.  A [GitHub Gists](https://gist.github.com/) or files in public GitHub repos both have CORS headers to raw links so will work. Make sure you click on the raw button to get a URL that goes directly to your raw code.  We plan to add a feature in the future to enable users to share and load code from OneDrive or SharePoint using their credentials, similar to how [Office Scripts](https://learn.microsoft.com/en-us/office/dev/scripts/overview/excel) currently work.

## RUNPY Function

See our [example workbook](https://1drv.ms/x/s!AmvHMvGKbZDOibEu75MVo8mvZqbAkg?e=XRMdBI) for usage.

The `RUNPY` function executes Python code and returns the result.  Optional positional arguments `arg1, arg2, ...` (similar to Python *args) are set as globals to pass as arguments of your Python function.

```excel
=BOARDFLARE.RUNPY(code, [arg1])
```

For example, if the following Python code is stored in cell `A1`:

```python
def add(a, b):
  return a + b
add(arg1,arg2)
```

You can run this code and pass the arguments `arg1 = 2`, `arg2 = 3` as follows:

```excel
=BOARDFLARE.RUNPY(A1,2,3)
```

### Arguments

| Argument | Type            | Optional | Description                                                                |
|----------|-----------------|----------|----------------------------------------------------------------------------|
| code     | string          | No       | Python code text, or URL to code, e.g. `https://gist.github.com/code.py`.  |
| arg1     | scalar or array | Yes      | Sets globals `arg1, arg2, ..` to pass in data.                             |

The table below shows how values for `arg1, arg2, ..` are converted from Excel to Python types:

| Excel Type | Example    | Python Type | Notes                             |
|------------|------------|-------------|-----------------------------------|
| Number     | 42         | int         |                                   |
| Number     | 3.14       | float       |                                   |
| String     | "hello"    | str         |                                   |
| Boolean    | TRUE       | bool        |                                   |
| Array      | `{1, 2, 3}`| DataFrame   | An array constant                 |
| Array      | A1:B2      | DataFrame   | A range of cells in an Excel sheet|

Arrays are converted to a pandas DataFrame without headers.

### Return Values

The value of the last expression in your Python code is returned as the result of the `BOARDFLARE.RUNPY` function, similar to a Jupyter notebook cell, or Excel's PY.  A good practice is to define a function and then call that function on the last line.  For example, in the following code returns the sum of the arguments:

```python
# Using BOARDFLARE.RUNPY
def add(a, b):
  return a + b
add(arg1,arg2)
```

The value of this Python expression must be one of those in the table below, which will be converted to the corresponding Excel types.

| Python Type | Example    | Excel Type |
|-------------|------------|------------|
| int         | 42         | Number     |
| float       | 3.14       | Number     |
| str         | "hello"    | String     |
| bool        | True       | Boolean    |
| 2D list (Matrix)    | [[1, 2], [3, 4]] | Array |
| 2D list (Column Vector) | [[1], [2], [3]] | Array |
| 2D list (Row Vector) | [[1, 2, 3]] | Array |

Other Python types such as Numpy arrays, Pandas DataFrames, dicts, tuples, etc., are not supported and will result in an error.  If you need to return a more complex data structure for use in another function, you can convert it to a string using `json.dumps`.

### Excel PY Compatibility

While `RUNPY` is intended to address a different use-case than Excel's `PY` function, we have tried to keep them as similar as possible so that you can re-use code between them.  Specifically, we also convert arrays to pandas DataFrames without headers, and the last expression in the code is the return value.  `RUNPY` return values are restricted to scalars and lists only.  If imported packages are available in both environments, the same code should work in both, with the only difference being how the arguments are passed, as shown in the highlighted lines below.

```python {4}
# Using BOARDFLARE.RUNPY
def add(a, b):
  return a + b
add(arg1,arg2)
```


```python {4}
# Using Excel's PY
def add(a, b):
  return a + b
add(xl("A2"),xl("B2"))
```

`RUNPY` takes arguments like a regular Excel function which enables you to use it Excel formulas, whereas Excel's `PY` is more of an interactive environment which enables you to reference Excel cells directly.  Each approach has its own strengths and weaknesses, and it is convenient to be able to easily move code between them as needed with minimal changes.

We decided to change our main function name to `RUNPY` to avoid confusion with Excel's `PY` function.

## Use Cases

Some key use-cases we see are as follows:

1. **Python-powered LAMBDAs**: Named LAMBDA functions enable the creation highly-customized custom functions, but they are limited by what can be done with Excel functions.  `BOARDFLARE.RUNPY` allows Python to be used inside LAMBDA functions enabling them to be as powerful as custom functions which previously required building an Excel add-in.  We plan to fully explote this capability by creating a library of Python functions and LAMBDA functions which consume them for various use-cases.

2. **Local Processing**: Often local processing is preferred for privacy, peformance, or cost reasons.  In addition to Python running locally, we plan to enable Python code to use local AI models similar to those used in our other add-ins (e.g. Local GPT, Translate, etc.).

3. **Calling APIs**:  There are many instances where calling a REST API (e.g. using a LLM from OpenAI) or scraping a web page would be useful.

## Changelog

1.0.5 - 2024-10-19
- `RUNPY` is a new function which handles both arrays and scalars similar to the `PY` function in Excel.
- `PY` and `PY.ARR` functions have been deprecated and will be removed on Nov 1, 2024.
- Beta version of Jupyterlite.

1.0.4 - 2024-09-25
- Added ability to load code from URL to `PY` and `PY.ARR` functions.  `PY.BETA` now has no new features, but will be where new features are tested before moving to `PY` and `PY.ARR`.

1.0.3 - 2024-09-24
- Added `PY.BETA` function with ability to load code from a URL.
- Improved error handling.
- Fixed bug blocking Mac users.

1.0.2 - 2024-09-15
- Improved error handling and reporting.
- Changed to using `pyout` as the output variable.

1.0.1 - 2024-09-12
- Added `PY.ARR` function to handle arrays natively.

1.0.0 - 2024-09-10
- Initial release.