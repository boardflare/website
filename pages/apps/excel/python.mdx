---
title: Python for Excel
---

import { Callout } from 'nextra/components'

# Python for Excel

<Callout type="warning" emoji="üß™">
  **EXPERIMENTAL**:  Expect breaking changes.
</Callout>

<a href="https://appsource.microsoft.com/en-us/product/office/WA200007447?tab=Overview">
    <img 
        src="/images/MS_AppSource.png" 
        alt="AppSource"
        style={{ paddingTop: '10px', width: '150px' }}
    />
</a>

## Python as a Function

Run Python code as a function to power your formulas and LAMBDA functions, which is not possible with Excel's native `PY` feature.  It is as simple as the following:
    
```excel
=LAMBDA(x, BOARDFLARE.RUNPY("arg1 + 2", x))
=MYFUNC(5) = 7
```
This enables you to build custom functions using Python without building a custom Excel add-in.  This add-in was originally conceived as an internal tool for prototyping custom functions based on Python without the overhead of building a full add-in.  We realized that others could benefit from the same capability, so we decided to release it as a free add-in on the Microsoft AppSource store.

## Benefits

This is a minimalist tool which is not designed to compete with the native [Python in Excel](https://support.microsoft.com/en-us/office/get-started-with-python-in-excel-a33fbcbe-065b-41d3-82cf-23d05397f53d), but it does offer some unique benefits as follows:

‚úÖ Use Python as a function in formulas and LAMBDAs.<br/>
üÜì Free add-in, no Office 365 license required.<br/>
üåê Works in Excel for web as well as desktop.<br/>
‚òÅÔ∏è Runtime has network access for API calls (need CORS).<br/>
üì¶ Import custom packages (pure Python only).<br/>
üîí Runs locally, so no data is shared outside Excel.<br/>
‚û°Ô∏è Code can be loaded from a URL (e.g. GitHub).<br/>
üöÄ Performance is only limited by your CPU.<br/>

## Python Runtime

[Pyodide](https://pyodide.org/en/stable/index.html) is the Python runtime, which is based on [WebAssembly](https://webassembly.org/) running in the browser used by Excel desktop and web to host add-ins.  This is currently running Python 3.12, but has limitations as discussed in the [Pyodide documentation](https://pyodide.org/en/stable/usage/wasm-constraints.html).

Any output to `stdout` or `stderr` is displayed in the Console area of the add-in task pane. This is useful for debugging your code, and also for displaying intermediate results of long-running operations such as functions that are processing large input arrays

### Custom Packages

Pyodide includes a number of [built-in packages](https://pyodide.org/en/stable/usage/packages-in-pyodide.html). You can import any of these packages as well as those from the Python standard library. Any imports for external Python packages will be loaded from [PyPI](https://pypi.org/), but only if they are pure Python, which means there is a Python wheel that ends with `-py3-none-any.whl`, e.g. `beautifulsoup4-4.12.3-py3-none-any.whl`.  Packages tagged as [OS-independent](https://pypi.org/search/?q=&o=&c=Operating+System+%3A%3A+OS+Independent) on PyPI should work, but double-check the wheel.

You do not need to install packages, just import them in your code.  Your code will be scanned for imports and any found will be handled for you using `micropip` in the background and the package will be downloaded if needed from PyPI.  If you try to import an external package (not part of the Python standard library or one of the built-in packages) for which there is not a pure Python wheel available on PyPI, an error will be thrown.

### Remote Code

If a URL starting with `https://` is provided for the code string, it will be fetched and the text contents used as the code.  Excel add-ins run in a browser instance, even for desktop apps, so be aware of the following restrictions when loading code from a URL:

- `http://` links will not work due to browser security restrictions.
- The server must respond with a CORS header to allow the request.  This is the case for GitHub Gists and raw links to files in public GitHub repos.  Note that GitHub Gist raw links change each time you edit the file and create a new version.

Public links to files in OneDrive or SharePoint will not work due to lack of CORS headers, but we plan to add a feature to enable users to share and load code from OneDrive or SharePoint, similar to how [Office Scripts](https://learn.microsoft.com/en-us/office/dev/scripts/overview/excel) currently work.

## RUNPY Function

The `RUNPY` function executes Python code and returns the result.  Optional positional arguments `arg1, arg2, ...` (similar to Python *args) are set as globals to pass as arguments of your Python function.

```excel
=BOARDFLARE.RUNPY(code, [arg1])
```

For example, if the following Python code is stored in cell `A1`:

```python
def add(a, b):
  return a + b
add(arg1,arg2)
```

You can run this code and pass the arguments `arg1 = 2`, `arg2 = 3` as follows:

```excel
=BOARDFLARE.RUNPY(A1,2,3)
```

See our [examples](#examples) section below for more.

### Arguments

| Argument | Type            | Optional | Description                                                                |
|----------|-----------------|----------|----------------------------------------------------------------------------|
| code     | string          | No       | Python code text, or URL to code, e.g. `https://gist.github....code.py`.  |
| arg1     | scalar or array | Yes      | Repeating argument that sets globals `arg1, arg2, ..` to pass in data.                             |

The table below shows how argument values for `arg1, arg2, ..` are converted from Excel to Python types:

| Excel Type | Example                        | Python Type |
|------------|--------------------------------|-------------|
| Number     | 42                             | int         |
| Number     | 3.14                           | float       |
| String     | "hello"                        | str         |
| Boolean    | TRUE                           | bool        |
| Array      | `{1, 2, 3}`                    | DataFrame   |
| Array      | A1:B2                          | DataFrame   |
| Null       | Reference to an empty cell     | None        |
| Null       | Unset optional LAMBDA argument | None        |
| Null       | Arg skipped with `,`           | None        |

- Argument values are cleared after each function invocation.
- Arrays are converted to a pandas DataFrame without headers.
- Skipping an arg with a comma, sets that arg to None. e.g. `=BOARDFLARE.RUNPY("some code",,3)` sets `arg1 = None` and `arg2 = 3`.
- Unset optional args in a LAMBDA also become `None`. e.g. `=LAMBDA([x], BOARDFLARE.RUNPY("3 + arg1", x))()` will set `arg1 = None` and throw an error in this example because `None` is not a valid Python type for the `+` operator, so you would need to handle this case in your Python code.

### Return Values

The value of the last expression in your Python code is returned by the `BOARDFLARE.RUNPY` function, similar to a Jupyter notebook cell, or Excel's `PY`.  A good practice is to wrap your code in a function, and then call that function on the last line.  For example, the following code returns the sum of the arguments:

```python
def add(a, b):
  return a + b

add(arg1,arg2)
```

The last expression must return a Python type in the table below, which will be converted to the corresponding Excel type.

| Python Type             | Example            | Excel Type |
|-------------------------|--------------------|------------|
| int                     | 42                 | Number     |
| float                   | 3.14               | Number     |
| str                     | "hello"            | String     |
| bool                    | True               | Boolean    |
| 2D list (Matrix)        | [[1, 2], [3, 4]]   | Array      |
| 2D list (Column Vector) | [[1], [2], [3]]    | Array      |
| 2D list (Row Vector)    | [[1, 2, 3]]        | Array      |

If the last expression returns another Python type such as Numpy array, Pandas DataFrame, dict, tuple, etc., it will throw an error.  If you need to return a more complex data structure for use in another function, you can convert it to a JSON string using `json.dumps`.

### Excel PY Compatibility

`RUNPY` takes arguments like a regular Excel function which enables you to use it Excel formulas, whereas Excel's `PY` is more of an interactive environment which enables you to reference Excel cells directly.  Each approach is useful for different use-cases, so it would be convenient to be able to use the same code in either.

To help achieve this, `RUNPY` also does the following:
- converts Excel arrays to pandas DataFrames without headers
- returns the value of the last expression in the code.  

If imported packages are available in both environments, the same code should work in both, with the only difference being how the arguments are passed to the Python function, as shown in the highlighted lines below.

```python {5}
# Using BOARDFLARE.RUNPY
def add(a, b):
  return a + b

add(arg1,arg2)
```


```python {5}
# Using Excel's PY
def add(a, b):
  return a + b

add(xl("A2"),xl("B2"))
```

While maybe not our preferred development tool, the Excel `PY` can be a handy way for writing quick code snippets with syntax highlighting before moving code to `RUNPY` for use in Excel formulas.

## Examples

### Workbooks

Here are some example workbooks, which also include a demo of using Excel's `PY` feature for comparison:
- [Simple Examples](https://whistlernetworks.sharepoint.com/:x:/s/Boardflare/EZ3eKR1wcltImmG2OA4sX-kB8RSA2cvJFM-hPoQGGdwMmA?e=m0eFdd)
- [Fuzzy Matching](https://whistlernetworks.sharepoint.com/:x:/s/Boardflare/Eb_nCI4mR6tImGx_S1hPVs8B4UYmrJRrkk0_Grai6A4adg?e=xfUuNQ)

### Code

Here are some simple code examples to get you started:

```python
# Function to convert inches to mm.
def inches_to_mm(inches):
    return inches * 25.4

inches_to_mm(arg1)
```

```python
# Function to calculate the area of a circle.
import math

def circle_area(radius):
    return math.pi * radius ** 2

circle_area(arg1)
```

```python
# Function to extract email address from a string.
import re

def extract_email(text):
    return re.search(r'[\w\.-]+@[\w\.-]+', text).group(0)

extract_email(arg1)
```

See this [workbook](https://whistlernetworks.sharepoint.com/:x:/s/Boardflare/Eb_nCI4mR6tImGx_S1hPVs8B4UYmrJRrkk0_Grai6A4adg?e=xfUuNQ) for demos of fuzzy matching functions and showing their use relative to Excel's native `PY` feature.

## Errors

Here are some common Excel cell errors you may encounter:

- `#VALUE!`:  An argument to a function is missing or it is the wrong type (e.g. incorrect range reference).
- `#NAME?`:  The function name is spelled incorrectly, e.g. `BOARDFLARE.RUNPYY`.
- `#BUSY!`:  This is normal for 5-10 seconds if you are importing libraries for the first time and have a slow internet connection. 

To the left of the bottom of the task pane, you may also see additional errors such as the following:

- `Error loading add-ins`
- `We're starting the add-ins runtime, just a moment...`

Unfortunately, the custom function capability of Excel can be a bit buggy and will throw various errors when the custom function is not being properly initialized by Excel.  If you think this is the case, try restarting Excel, or reloading the browser window.

## Use Cases

Some key use-cases we see are as follows:

1. **Python-powered LAMBDAs**: `RUNPY` allows Python to be used inside LAMBDA functions enabling them to be as powerful as custom functions which previously required building an Excel add-in.

2. **Local Processing**: Often local processing is preferred for privacy, peformance, or cost reasons.

3. **Accessing APIs**:  e.g. using LLM from OpenAI, loading or pushing data where Power Query is not suitable, etc.

## Changelog

1.0.5 - 2024-10-22
- `RUNPY` is a new function which handles both arrays and scalars similar to the Excel's `PY`.
- `PY` and `PY.ARR` functions have been deprecated and will be removed on Dec 1, 2024 to avoid confusion.

1.0.4 - 2024-09-25
- Added ability to load code from URL to `PY` and `PY.ARR` functions.  `PY.BETA` now has no new features, but will be where new features are tested before moving to `PY` and `PY.ARR`.

1.0.3 - 2024-09-24
- Added `PY.BETA` function with ability to load code from a URL.
- Improved error handling.
- Fixed bug blocking Mac users.

1.0.2 - 2024-09-15
- Improved error handling and reporting.
- Changed to using `pyout` as the output variable.

1.0.1 - 2024-09-12
- Added `PY.ARR` function to handle arrays natively.

1.0.0 - 2024-09-10
- Initial release.