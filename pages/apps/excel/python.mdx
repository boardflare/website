---
title: Python for Excel
---

# Python for Excel

<a href="https://appsource.microsoft.com/en-us/product/office/WA200007447?tab=Overview">
    <img className="mt-2 w-40" src="/images/MS_AppSource.png" />
</a>

## Overview

The `BOARDFLARE.RUNPY` function enables you to run Python code in formulas and LAMBDA functions, which is not possible with Excel's native `PY` feature.  It is as simple as the following:
    
```excel
=LAMBDA(x, BOARDFLARE.RUNPY("arg1 + 2", x))
=MYFUNC(5) = 7
```
This enables you to build custom functions using Python without building a custom Excel add-in.  This was originally conceived as an internal tool for prototyping custom functions based on Python, and we decided to publish it as a free add-in.

This is a minimalist tool which is not designed to compete with the native [Python in Excel](https://support.microsoft.com/en-us/office/get-started-with-python-in-excel-a33fbcbe-065b-41d3-82cf-23d05397f53d), but it does offer some unique benefits as follows:

‚úÖ Use Python in formulas and named LAMBDA functions.<br/>
üÜì Free add-in, no Office 365 license required.<br/>
üåê Works in Excel for web as well as desktop.<br/>
‚òÅÔ∏è Runtime has network access for API calls (need CORS).<br/>
üì¶ Import custom packages (pure Python only).<br/>
üîí Code is stored in your workbook and runs locally.<br/>

## Python Packages

[Pyodide](https://pyodide.org/en/stable/index.html) is the Python runtime used by the add-in, and includes a number of [built-in packages](https://pyodide.org/en/stable/usage/packages-in-pyodide.html). You can import any of these packages as well as those from the Python standard library. Any imports for external Python packages will be loaded from [PyPI](https://pypi.org/), but only if they are pure Python, and depend on any packages that are either built into pyodide or also pure Python.  Packages tagged as [OS-independent](https://pypi.org/search/?q=&o=&c=Operating+System+%3A%3A+OS+Independent) on PyPI should work.

Your code will be scanned for imports and any found will be handled for you using `micropip` in the background and the package will be downloaded if needed from PyPI. If you try to import an external package (not part of the Python standard library or one of the built-in packages) for which there is not a pure Python wheel available on PyPI, an error will be thrown.  However, specific imports (e.g., `from azure.core.credentials import AzureKeyCredential`) will not automatically install the relevant package. You need to handle these manually using `await micropip.install(['package1', 'package2'])`. `micropip` has already been imported for you.  For example:

```python
await micropip.install(['azure-ai-textanalytics'])
from azure.ai.textanalytics import TextAnalyticsClient
```

## Code Editor üÜï

The simplest way to create a named LAMBDA function using Python is to click on the `Editor` tab, write a Python function, click `Save` and a named LAMBDA will be created automatically.  Let's say you write the following Python function:

```python
def hello(first, last):
    """ Returns a greeting. """
    greeting = f"Hello {first, last}!"
    return greeting
    
# Example arguments.
examples = [["Nancy", "Morgan"], ["Ming", "Lee"]]
```

When you save this function, the function name `hello` and arguments `first, last` will be used to create a named LAMBDA `HELLO (first, last)`.  The Python code is saved to the workbook settings, and the LAMBDA function will be of the following form:

```excel
=LAMBDA(first, last, BOARDFLARE.RUNPY("workbook-settings:hello", first, last))
```
The docstring of the Python function is also used to create a description for the named LAMBDA function.  

![Hello Function](/images/hello-function.png)

Each time the function is run, BOARDFLARE.RUNPY loads the code from the workbook settings and runs it.  Since the code and named LAMBDA are both stored in the workbook, anyone who opens the workbook can use the function.  If you want to copy the function to another workbook, for now you need to copy the code from the `Editor` tab and paste it into the `Editor` tab of the other workbook.

The `examples` variable contains a list of arguments you can use to test your function.  When you click `Test` in the editor you will be taken to the `Logs` tab where you view the output from executing the function with the example arguments.  When you click `Save`, a demo sheet is created which invokes the function with the examples. 

### Arguments

The arguments of your Excel function will be converted to the following Python types before they are passed to your Python function:

| Excel Type | Example                        | Python Type |
|------------|--------------------------------|-------------|
| Number     | 42                             | int         |
| Number     | 3.14                           | float       |
| String     | "hello"                        | str         |
| Boolean    | TRUE                           | bool        |
| Array      | `{1, 2, 3}`                    | DataFrame   |
| Array      | A1:B2                          | DataFrame   |
| Null       | Reference to an empty cell     | None        |
| Null       | Unset optional LAMBDA argument | None        |
| Null       | Arg skipped with `,`           | None        |

### Returns

The value returned by your Python function will be converted to the corresponding Excel type as follows:

| Python Type             | Example            | Excel Type |
|-------------------------|--------------------|------------|
| int                     | 42                 | Number     |
| float                   | 3.14               | Number     |
| str                     | "hello"            | String     |
| bool                    | True               | Boolean    |
| 2D list (Matrix)        | [[1, 2], [3, 4]]   | Array      |
| 2D list (Column Vector) | [[1], [2], [3]]    | Array      |
| 2D list (Row Vector)    | [[1, 2, 3]]        | Array      |

If your function returns another Python type such as numpy array, pandas DataFrame, dict, tuple, etc., an error will be thrown.

## BOARDFLARE.RUNPY Function

You may also use the `RUNPY` function directly if you need more control over where the code is stored, or want to write your own LAMBDA wrapper around it.  `RUNPY` executes Python code and returns the result.  Optional positional arguments `arg1, arg2, ...` (similar to Python *args) are set as globals to pass as arguments of your Python function.

```excel
=BOARDFLARE.RUNPY(code, [arg1],[arg2],...)
```
A simple example is as follows:

```excel
=BOARDFLARE.RUNPY("2 + arg1", 3)
=5
```

Here is a [brief video](https://youtu.be/ngxM7VRkkgk) showing how to use the `RUNPY` function.

`code` must be a string containing Python code, which can be a simple expression or a block of code.  `code` can also be a URL, e.g. `https://gist.github.com...code.py`, which must return code in plain text.  Note that the URL must be `https` and return an `Access-Control-Allow-Origin` [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS) header.

The value of the last expression in your Python code is returned, or if you define a variable `result`, that will be used instead.  For example:

```python
import numpy as np

def add(a, b):
    return np.add(a, b).item()

result = add(arg1, arg2)
```

## Examples

### Workbooks

- [Simple Examples](https://whistlernetworks.sharepoint.com/:x:/s/Boardflare/EZ3eKR1wcltImmG2OA4sX-kB8RSA2cvJFM-hPoQGGdwMmA?e=m0eFdd) shows basic usage and also demonstrates how the same code can also be used in Excel PY().
- [Fuzzy Matching with text_distance](https://whistlernetworks.sharepoint.com/:x:/s/Boardflare/EZGMy4IzfYhEsB4Vvi72r-YBIsneUMXilM8_Cv2T-WTvvQ?e=jVv6Bq) is a more advanced example using an imported Python package and loads code from our functions repository.  Click on the documentation link in the workbook for more details.

### Code

Here are some simple code examples to get you started:

```python
# Function to convert inches to mm.
def inches_to_mm(inches):
    return inches * 25.4

inches_to_mm(arg1)
```

```python
# Function to calculate the area of a circle.
import math

def circle_area(radius):
    return math.pi * radius ** 2

circle_area(arg1)
```

```python
# Function to extract email address from a string.
import re

def extract_email(text):
    return re.search(r'[\w\.-]+@[\w\.-]+', text).group(0)

extract_email(arg1)
```

## Errors

Here are some Excel errors you may encounter:

- `#VALUE!`:  An argument to a function is missing or it is the wrong type (e.g. incorrect range reference).
- `#NAME?`:  The function name is spelled incorrectly, e.g. `BOARDFLARE.RUNPYY`.
- `#BUSY!`:  This is normal for 5-10 seconds if you are importing libraries for the first time and have a slow internet connection. 

To the left of the bottom of the task pane, you may also see additional errors such as the following:

- `Error loading add-ins`
- `We're starting the add-ins runtime, just a moment...`

Unfortunately, the custom function capability of Excel can be a bit buggy and will throw various errors when the custom function is not being properly initialized by Excel.  If you think this is the case, try restarting Excel, or reloading the browser window.

## FAQ

<details>
  <summary>Can I link to code in OneDrive or SharePoint?</summary>
  No.  Public links to files in OneDrive or SharePoint will not work due to lack of CORS headers, but we plan to add a feature to enable users to share and load code from OneDrive or SharePoint, similar to how [Office Scripts](https://learn.microsoft.com/en-us/office/dev/scripts/overview/excel) currently work.
</details>

<details>
  <summary>Can Python code access the network?</summary>
  You should be able to access any public API that supports [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS).
</details>

<details>
  <summary>Can I use a GitHub Gist or raw link to a file in a public GitHub repo?</summary>
  Yes. Both apply CORS. Note that GitHub Gist raw links change each time you edit the file and create a new version.
</details>

<details>
  <summary>Can I use a URL to a file in a private GitHub repo?</summary>
  No.  The URL must be public and accessible without authentication.
</details>

<details>
  <summary>Is the code compatible with the native Excel PY function?</summary>
  Yes.  Just define the global variables `arg1, arg2,...` at the top as shown in the highlighted lines below.  `RUNPY` converts Excel arrays to pandas DataFrames without headers the same as Excel PY does.

  ```python {1-2}
arg1 = xl("A2")
arg2 = xl("B2")

def add(a, b):
  return a + b

add(arg1,arg2)
```
</details>

<details>
  <summary>Is running Python in Excel secure?</summary>
  The Pyodide runtime runs in a [Web Worker](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API), which is a separate thread from the main Excel add-in thread, and does not have direct access to your workbook other than the data you pass to it as arg1, arg2, etc.  However, hackers are creative and tend to find security loopholes, so just like with VBA, you should never run code from an untrusted source.
</details>

<details>
  <summary>Where is `stdout` or `stderr` is displayed?</summary>
  Any output to `stdout` or `stderr` is displayed in the Logs tab of the add-in task pane, but it is only returned at the completion of the execution of your code, so you can't use use `print` statements to view progress of long-running operations.  
</details>

## Use Cases

Some key use-cases we see are as follows:

1. **Python-powered LAMBDAs**: `RUNPY` allows Python to be used inside LAMBDA functions enabling them to be as powerful as custom functions which previously required building an Excel add-in.

2. **Local Processing**: Often local processing is preferred for privacy, performance, or cost reasons.

3. **Accessing APIs**:  e.g. using LLM from OpenAI, loading or pushing data where Power Query is not suitable, etc.

## Changelog

1.1.0 - 2025-01-05
- Added `Editor` tab to create named LAMBDA functions from Python code.

1.0.7 - 2024-11-01
- Removed deprecated `PY` and `PY.ARR` functions.

1.0.6 - 2024-10-28
- No longer throws error if you pass None as an argument to `RUNPY`, so you need to handle this in your code (e.g. if you pass an empty cell). See [Arguments](#arguments) for more details.

1.0.5 - 2024-10-22
- `RUNPY` is a new function which handles both arrays and scalars similar to the Excel's `PY`.
- `PY` and `PY.ARR` functions have been deprecated and will be removed on Nov 1, 2024 to avoid confusion.

1.0.4 - 2024-09-25
- Added ability to load code from URL to `PY` and `PY.ARR` functions.  `PY.BETA` now has no new features, but will be where new features are tested before moving to `PY` and `PY.ARR`.

1.0.3 - 2024-09-24
- Added `PY.BETA` function with ability to load code from a URL.
- Improved error handling.
- Fixed bug blocking Mac users.

1.0.2 - 2024-09-15
- Improved error handling and reporting.
- Changed to using `pyout` as the output variable.

1.0.1 - 2024-09-12
- Added `PY.ARR` function to handle arrays natively.

1.0.0 - 2024-09-10
- Initial release.