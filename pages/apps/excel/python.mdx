---
title: Python for Excel
---

# Python for Excel

<a href="https://appsource.microsoft.com/en-us/product/office/WA200007447?tab=Overview">
    <img className="mt-2 w-40" src="/images/MS_AppSource.png" />
</a>

## Overview

This add-in enables you to easily create custom functions in Excel using Python in two easy steps:
1. Write your Python function code in the `Editor` tab.
2. Click `Save` to create a [LAMBDA function](https://support.microsoft.com/en-us/office/lambda-function-bd212d27-1cd1-4321-a34a-ccbf254b8b67) in Excel.

For example, you can write a Python function to convert inches to millimeters as follows:

```python
def inches_to_mm(inches):
    """ Converts inches to millimeters. """
    return inches * 25.4
```

When you click `Save`, a [LAMBDA](https://support.microsoft.com/en-us/office/lambda-function-bd212d27-1cd1-4321-a34a-ccbf254b8b67) function `INCHES_TO_MM(inches)` will be created in your workbook.  You can then use this function in Excel as follows:

```excel
=INCHES_TO_MM(3)
```

Some key features are as follows:

‚úÖ Use Python in formulas and named LAMBDA functions.<br/>
üÜì Free add-in, no Office 365 license required.<br/>
üåê Works in Excel for web as well as desktop.<br/>
‚òÅÔ∏è Runtime has network access for API calls (needs CORS).<br/>
üì¶ Import custom packages (pure Python only).<br/>
üîí Code is stored in your workbook and runs locally.<br/>
üöÄ No sign-in is required to use basic features.<br/>

## Code Editor üÜï

The simplest way to create a named LAMBDA function using Python is to click on the `Editor` tab, write a Python function, click `Save` and a named LAMBDA will be created automatically.  Let's say you write the following Python function:

```python
def hello(first, last):
    """ Returns a greeting. """
    greeting = f"Hello {first, last}!"
    return greeting
```

When you save this code, the Python function name `hello` and arguments `first, last` will be used to create a LAMBDA `=HELLO (first, last)`.  The Python code is saved to the [workbook settings](https://learn.microsoft.com/en-us/office/dev/add-ins/excel/excel-add-ins-workbooks#access-document-settings), and a LAMBDA function is added to the Excel name manager as follows:

```excel
=LAMBDA(first, last, BOARDFLARE.RUNPY("workbook-settings:hello", first, last))
```
The docstring of the Python function is also added to the name manager to provide a description users can see when they use the function.

![Hello Function](/images/hello-function.png)

Each time the function is used `BOARDFLARE.RUNPY` loads the code from the workbook settings and runs it with the arguments.  Since the code and LAMBDA are both stored in the workbook, anyone who opens the workbook can use the function.  If they don't have the add-in installed, Excel will automatically prompt them to do so.  To copy the function to another workbook, for now you need to copy/paste the code and re-create it.

## Type Conversion

When arguments are passed from Excel to your Python code the following type conversions take place:

| Excel Type | Example                        | Python Type |
|------------|--------------------------------|-------------|
| Number     | 42                             | int         |
| Number     | 3.14                           | float       |
| String     | "hello"                        | str         |
| Boolean    | TRUE                           | bool        |
| Array      | `{1, 2, 3}`                    | DataFrame   |
| Array      | A1:B2                          | DataFrame   |
| Null       | Reference to an empty cell     | None        |
| Null       | Unset optional LAMBDA argument | None        |
| Null       | Arg skipped with `,`           | None        |
| Date       | Not currently supported        | n/a         |

The value returned by your Python function will be converted to the corresponding Excel type as follows:

| Python Type             | Example            | Excel Type |
|-------------------------|--------------------|------------|
| int                     | 42                 | Number     |
| float                   | 3.14               | Number     |
| str                     | "hello"            | String     |
| bool                    | True               | Boolean    |
| 2D list (Matrix)        | [[1, 2], [3, 4]]   | Array      |
| 2D list (Column Vector) | [[1], [2], [3]]    | Array      |
| 2D list (Row Vector)    | [[1, 2, 3]]        | Array      |
| numpy array             | np.array([1, 2, 3])| Array      |
| pandas DataFrame        | DataFrame          | Array      |
| None                    | None               | Null       |

If your function returns another Python type such as a dict, tuple, etc., an error will be thrown.

## Test Cases

If you provide a `test_cases` variable in your code with a list of arguments, this will be used to test your function. When you click `Test` in the editor you will be taken to the `Logs` tab where you view the output from executing the function with the arguments provided in the `test_cases`.  When you click `Save`, a demo sheet is also created which shows the function output with the `test_cases`.  Note that the arguments need to be in the same order as the function arguments and of an Excel type.

For examnple:

```python
def hello(first, last):
    """ Returns a greeting. """
    greeting = f"Hello {first, last}!"
    return greeting
    
# Test cases for the function.
test_cases = [["Nancy", "Morgan"], ["Ming", "Lee"]]
```

If your function only has one argument, then it would look as follows:

```python
def square(x):
    """ Returns the square of a number. """
    return x ** 2

# Test cases for the function.
test_cases = [2, 3, 4]
```

If an argument is an array, it needs to be provided as an [Excel array constant](https://support.microsoft.com/en-us/office/use-array-constants-in-array-formulas-477443ea-5e71-4242-877d-fcae47454eb8).  For example, if you have a function that squares each element in an array, you would define the test cases as follows:

```python
def square_array(arr):
    """ Returns the square of each element in an array. """
    return [x ** 2 for x in arr]

# Test cases for the function.
test_cases = [{1, 2, 3}, {4, 5, 6}]
```

## Importing Packages

[Pyodide](https://pyodide.org/en/stable/index.html) is the Python runtime used by the add-in, and includes a number of [built-in packages](https://pyodide.org/en/stable/usage/packages-in-pyodide.html). You can import any of these packages as well as those from the Python standard library. Any imports for external Python packages will be loaded from [PyPI](https://pypi.org/), but only if they are pure Python, and depend on any packages that are either built into pyodide or also pure Python.  Packages tagged as [OS-independent](https://pypi.org/search/?q=&o=&c=Operating+System+%3A%3A+OS+Independent) on PyPI should work.

Your code will be scanned for imports and any found will be handled for you using `micropip` in the background and the package will be downloaded if needed from PyPI. If you try to import an external package (not part of the Python standard library or one of the built-in packages) for which there is not a pure Python wheel available on PyPI, an error will be thrown.  However, specific imports (e.g., `from azure.core.credentials import AzureKeyCredential`) will not automatically install the relevant package. You need to handle these manually using `await micropip.install(['package1', 'package2'])`. `micropip` has already been imported for you.  For example:

```python
await micropip.install(['azure-ai-textanalytics'])
from azure.ai.textanalytics import TextAnalyticsClient
```

## RUNPY Function

This is an advanced alternative to using the code editor, and should only be used if you need more control over where the code is stored (e.g. GitHub) and how it is wrapped in a LAMBDA function (e.g. if you want to add extra logic in Excel).  `RUNPY` takes Python code and a repeating positional argument `arg1, arg2, ...` (similar to Python *args) and returns the result.  The syntax is as follows:

```excel
=BOARDFLARE.RUNPY(code, [arg1],[arg2],...)
```
A simple example is as follows:

```excel
=BOARDFLARE.RUNPY("2 + arg1", 3)
=5
```

Here is a [brief video](https://youtu.be/ngxM7VRkkgk) showing how to use the `RUNPY` function.

`code` must be a string containing Python code, which can be a simple expression or a block of code.  `code` can also be a URL, e.g. `https://gist.github.com...code.py`, which must return code in plain text.  Note that the URL must be `https` and return an `Access-Control-Allow-Origin` [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS) header due to browser security constraints.

The value of the last expression in your Python code is returned, or if you define a variable `result`, that will be used instead.  For example:

```python
import numpy as np

def add(a, b):
    return np.add(a, b).item()

result = add(arg1, arg2)
```

## Examples

- [Simple Examples](https://whistlernetworks.sharepoint.com/:x:/s/Boardflare/EZ3eKR1wcltImmG2OA4sX-kB8RSA2cvJFM-hPoQGGdwMmA?e=m0eFdd) shows basic usage and also demonstrates how the same code can also be used in Excel PY().
- [Fuzzy Matching with text_distance](https://whistlernetworks.sharepoint.com/:x:/s/Boardflare/EZGMy4IzfYhEsB4Vvi72r-YBIsneUMXilM8_Cv2T-WTvvQ?e=jVv6Bq) is a more advanced example using an imported Python package and loads code from our functions repository.  Click on the documentation link in the workbook for more details.

Here are some simple code examples to get you started:

```python
# Function to convert inches to mm.
def inches_to_mm(inches):
    return inches * 25.4

inches_to_mm(arg1)
```

```python
# Function to calculate the area of a circle.
import math

def circle_area(radius):
    return math.pi * radius ** 2

circle_area(arg1)
```

```python
# Function to extract email address from a string.
import re

def extract_email(text):
    return re.search(r'[\w\.-]+@[\w\.-]+', text).group(0)

extract_email(arg1)
```

## FAQ

<details>
  <summary>Why am I getting Excel errors like `#VALUE!`, `#NAME?`, `#BUSY!`?</summary>
  - `#VALUE!`:  An argument to a function is missing or it is the wrong type (e.g. incorrect range reference).
  - `#NAME?`:  The function name is spelled incorrectly, e.g. `BOARDFLARE.RUNPYY`.
  - `#BUSY!`:  This is normal for 5-10 seconds if you are importing libraries for the first time and have a slow internet connection. 

  To the left of the bottom of the task pane, you may also see additional errors such as the following:

  - `Error loading add-ins`
  - `We're starting the add-ins runtime, just a moment...`

  Sometimes Excel will throw various errors when the custom function is not properly initialized, in which case you can try restarting Excel, or reloading the browser window.
</details>

<details>
  <summary>Can I link to code in OneDrive or SharePoint?</summary>
  No.  Public links to files in OneDrive or SharePoint will not work due to lack of CORS headers, but we plan to add a feature to enable users to share and load code from OneDrive or SharePoint, similar to how [Office Scripts](https://learn.microsoft.com/en-us/office/dev/scripts/overview/excel) currently work.
</details>

<details>
  <summary>Can Python code access the network?</summary>
  You should be able to access any public API that supports [CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS).
</details>

<details>
  <summary>Can I use a GitHub Gist or raw link to a file in a public GitHub repo?</summary>
  Yes. Both apply CORS. Note that GitHub Gist raw links change each time you edit the file and create a new version.
</details>

<details>
  <summary>Can I use a URL to a file in a private GitHub repo?</summary>
  No.  The URL must be public and accessible without authentication.
</details>

<details>
  <summary>Is the code compatible with the native Excel PY function?</summary>
  Yes.  Just define the global variables `arg1, arg2,...` at the top as shown in the highlighted lines below.  `RUNPY` converts Excel arrays to pandas DataFrames without headers the same as Excel PY does.

  ```python {1-2}
arg1 = xl("A2")
arg2 = xl("B2")

def add(a, b):
  return a + b

add(arg1,arg2)
```
</details>

<details>
  <summary>Is running Python in Excel secure?</summary>
  The Pyodide runtime runs in a [Web Worker](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API), which is a separate thread from the main Excel add-in thread, and does not have direct access to your workbook other than the data you pass to it as arg1, arg2, etc.  However, hackers are creative and tend to find security loopholes, so just like with VBA, you should never run code from an untrusted source.
</details>

<details>
  <summary>Where is `stdout` or `stderr` is displayed?</summary>
  Any output to `stdout` or `stderr` is displayed in the Logs tab of the add-in task pane, but it is only returned at the completion of the execution of your code, so you can't use use `print` statements to view progress of long-running operations.  
</details>

## Changelog

1.1.0 - 2025-01-06
- Added `Editor` tab to create named LAMBDA functions from Python code.

1.0.7 - 2024-11-01
- Removed deprecated `PY` and `PY.ARR` functions.

1.0.6 - 2024-10-28
- No longer throws error if you pass None as an argument to `RUNPY`, so you need to handle this in your code (e.g. if you pass an empty cell). See [Arguments](#arguments) for more details.

1.0.5 - 2024-10-22
- `RUNPY` is a new function which handles both arrays and scalars similar to the Excel's `PY`.
- `PY` and `PY.ARR` functions have been deprecated and will be removed on Nov 1, 2024 to avoid confusion.

1.0.4 - 2024-09-25
- Added ability to load code from URL to `PY` and `PY.ARR` functions.  `PY.BETA` now has no new features, but will be where new features are tested before moving to `PY` and `PY.ARR`.

1.0.3 - 2024-09-24
- Added `PY.BETA` function with ability to load code from a URL.
- Improved error handling.
- Fixed bug blocking Mac users.

1.0.2 - 2024-09-15
- Improved error handling and reporting.
- Changed to using `pyout` as the output variable.

1.0.1 - 2024-09-12
- Added `PY.ARR` function to handle arrays natively.

1.0.0 - 2024-09-10
- Initial release.